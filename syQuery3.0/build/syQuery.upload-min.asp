<%$.add("upload",function(){var c=function(){this.speed=100;this.cutLine="";this.cutLineLength=0;this.lastLine="";this.lastLineLength=0;this.saveType="time";this.uploadFile="upload";this.uploadType=["jpg","png","gif","bmp","rar","zip"];this.object=new ActiveXObject($.config.ActivexObject.stream);this.errorNumber=0;this.errorArray=[]};var e=/filename=\"([^\"]+)\"/i,g=/name=\"([^\"]+)\"/i,f=/Content-Type: ([^\n\r]+)/i;$.augment(c,{upload:function(i){if($.isFunction(this.beforeUpload)){if(this.beforeUpload()===false){return}}if(i){for(var j in i){this[j]=i[j]}}var h=$.Enumerator(Request.ServerVariables("HTTP_CONTENT_DISPOSITION"));if(h.length>0){return this.html5Upload(h)}else{return this.commonUpload()}},commonUpload:function(){var m=a.call(this),q=[],l,h,s,t,j,n,p,i={};this.object.Type=2;this.object.Open();this.object.WriteText(m);this.object.Position=0;this.object.Charset="ascii";this.object.Position=2;s=this.object.ReadText;this.cutLine=s.split("\n")[0];this.cutLineLength=this.cutLine.length;this.lastLine=this.cutLine.substring(0,this.cutLineLength-1);this.lastLineLength=this.lastLine.length;t=s;l=0;while((h=t.indexOf(this.cutLine))!=-1){j=l;n=j+h;p=t.substring(0,h);t=t.substring(h+this.cutLineLength);l=n+this.cutLineLength;q.push({data:p,start:j,end:n})}if((h=t.indexOf(this.lastLine))!=-1){j=l;n=j+h;p=t.substring(0,h);q.push({data:p,start:j,end:n})}q.map(function(w,v){if(/^\n+/.test(v.data)){v.start+=/^\n+/.exec(v.data)[0].length;v.data=v.data.replace(/^\n+/,"")}var u=v.data.split("\n\r");v.start+=(v.data.indexOf(u[1])+1);v.data=u[0];v.textValue=u.slice(1,-1).join("");return v}).each(function(v,u){if(g.test(u.data)){var w=g.exec(u.data),x=w[1];i[x]={};if(e.test(u.data)){w=e.exec(u.data);i[x].filename=w[1];w=f.exec(u.data);i[x].contentType=w[1];i[x].ext=i[x].filename.split(".").slice(-1).join("");i[x].size=u.end-u.start}i[x].STARTPOS=u.start;i[x].ENDPOS=u.end}});for(var k in i){var r=i[k];if(r.filename!=undefined&&r.filename.length>0){if(d(r.ext,this.uploadType)==false){if($.isFunction(this.onError)){this.onError({message:"上传格式不匹配"})}}else{try{this.saveObject=new ActiveXObject($.config.ActivexObject.stream);this.saveObject.Type=1;this.saveObject.Mode=3;this.saveObject.Open();this.object.Position=r.STARTPOS+2;this.object.CopyTo(this.saveObject,r.size);r.fileSavePath=b.call(this,r);this.saveObject.SaveToFile(Server.MapPath(r.fileSavePath),2);this.saveObject.Close();this.saveObject=null;if($.isFunction(this.onSuccess)){this.onSuccess.call(r)}}catch(o){if($.isFunction(this.onError)){this.onError(o)}}}}else{i[k].value=s.substring(r.STARTPOS,r.ENDPOS-2)}}return i},html5Upload:function(m){m=m[0];var i=g.exec(m),h=e.exec(m),k=f.exec(m),j={},l=a.call(this);if(i){j[i[1]]={};if(h){j[i[1]].filename=h[1];j[i[1]].size=Request.TotalBytes;j[i[1]].ext=h[1].split(".").slice(-1).join("");j[i[1]].contentType=k[1];j[i[1]].fileSavePath=b.call(this,j[i[1]]);(new $.use("stream")()).save(l,j[i[1]].fileSavePath,1)}else{if($.isFunction(this.onError)){this.onError({message:"找不到文件名，文件已损坏或废弃。"})}}}else{if($.isFunction(this.onError)){this.onError({message:"不支持HTML5控件"})}}return j}});function a(){var i=Request.TotalBytes,k=this.speed,j=0,l=0,h;if(i<k){k=i}this.object.Open();this.object.Type=1;while(j<i){if(j+k<i){l=k}else{l=i-j}j+=l;this.object.Write(Request.BinaryRead(l))}this.object.Position=0;h=this.object.Read();this.object.Close();return h}function d(j,l){var k=false;for(var h=0;h<l.length;h++){if(l[h]===j){k=true;break}}return k}function b(h){var i=this.uploadFile.replace(/\/+$/,"");if($.isArray(this.saveType)){return i+"/"+this.saveType.join(".")}else{if(this.saveType=="old"){return i+"/"+h.filename}else{if(this.saveType=="time"){return i+"/"+(new Date().getTime())+"."+h.ext}}}return i+"/"+(new Date().getTime())+"."+h.ext}return c},{reqiure:["stream"]});%>