<%$.add("package",function(){var e=function(){try{this.baseObject=new ActiveXObject("Microsoft.XMLDOM")}catch(g){this.baseObject=new ActiveXObject("Msxml2.DOMDocument.5.0")}};$.augment(e,{pack:function(i,g,p){p=$.extend({onError:null,replaceFolderPath:null,packedFolder:null,replaceFilePath:null,packedFile:null},p);var l=a(i);l.push(i);var n=f(l),j=l.length+n.length,m=this;var h='<?xml version="1.0"?><package xmlns:dt="urn:schemas-microsoft-com:datatypes"><count><foldercount></foldercount><filecount></filecount></count><content><folders></folders><files></files></content></package>',k=$.use("xml"),o=k.load(h);if(o!==false){k(o).getElementsByTagName("count").attr("total",j+"");k(o).getElementsByTagName("foldercount").text(l.length+"");k(o).getElementsByTagName("filecount").text(n.length+"");l.each(function(r,q){q=q.replace(/^(\.\.\/)+/,"");if($.isFunction(p.replaceFolderPath)){q=p.replaceFolderPath(q)}k(o).getElementsByTagName("folders").append("item").html(q);if($.isFunction(p.packedFolder)){p.packedFolder(q,r+1,l.length,j.length)}});n.each(function(s,q){var r=c(q);q=q.replace(/^(\.\.\/)+/,"");if($.isFunction(p.replaceFilePath)){q=p.replaceFilePath(q)}k(o).getElementsByTagName("files").append("item").attr({path:q,filename:q.split("/").last().join("")}).html(d.call(m,r));if($.isFunction(p.packedFile)){p.packedFile(q,s+1,n.length,j.length)}});k(o).saveXML(g)}else{if($.isFunction(p.onError)){p.onError.call(undefined,{message:"打开XML数据流失败"})}}},unpack:function(n,m,k){k=$.extend({onError:null,replaceFolderPath:null,packedFolder:null,replaceFilePath:null,packedFile:null},k);var j=0;ALLFOSNUM=0,ALLFISNUM=0,_this=this,m=m.replace(/\/+$/,"");var i=$.use("xml"),l=$.use("fso"),g=$.use("stream"),h=i.load(n);if(h!==false){j=Number(i(h).getElementsByTagName("count").attr("total"));ALLFOSNUM=Number(i(h).getElementsByTagName("foldercount").text());ALLFISNUM=Number(i(h).getElementsByTagName("filecount").text());i(h).getElementsByTagName("folders").getElementsByTagName("item").each(function(p,o){var q=m+"/"+i(o).text();if($.isFunction(k.replaceFolderPath)){q=k.replaceFolderPath(q)}l(q).create();if($.isFunction(k.packedFolder)){k.packedFolder(q,p+1,ALLFOSNUM,j)}});i(h).getElementsByTagName("files").getElementsByTagName("item").each(function(q,p){var r=m+"/"+i(p).attr("path"),s=i(p).attr("filename");if($.isFunction(k.replaceFilePath)){r=k.replaceFilePath(r)}if(s.toLowerCase()==="global.asa"){r=$.root+"global.asa"}var o=new g();o.save(b.call(_this,i(p).text()),r,1);o=null;if($.isFunction(k.packedFile)){k.packedFile(r,q+1,ALLFISNUM,j)}})}else{if($.isFunction(k.onError)){k.onError.call(undefined,{message:"打开XML数据流失败"})}}},fileEnCode:function(g){return d(c(g))},fileDeCode:function(g){return b(g)}});function a(j){var g=$.use("fso"),h=g(j).collect(true,true).toArray(),i=h;return i.map(function(m,l){return a(l)}).concat(h)}function f(h){var g=$.use("fso");return h.map(function(l,j){return g(j).collect(false,true).toArray()})}function c(i){var g=$.use("stream"),h=new g();return h.load(i,1)}function d(h){var g=this.baseObject.createElement("file");g.dataType="bin.base64";g.nodeTypedValue=h;return g.text}function b(h){var g=this.baseObject.createElement("file");g.dataType="bin.base64";g.text=h;return g.nodeTypedValue}return e},{reqiure:["stream","fso","xml"]});%>